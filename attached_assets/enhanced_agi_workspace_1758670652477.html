<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sovereign AGI Workspace</title>
  <!-- Tailwind for styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font for monospaced code blocks -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet" />
  <!-- Socket.IO -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <!-- JSZip and FileSaver for scaffolding downloads -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .code-block { font-family: 'Fira Code', monospace; background-color: #1e1e1e; color: #d4d4d4; border-radius: 0.375rem; padding: 1rem; white-space: pre-wrap; overflow-x: auto; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #0ea5e9; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
  <div class="container mx-auto p-4 md:p-8">
    <header class="text-center mb-8">
      <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-500">Sovereign AGI Workspace</h1>
      <p class="text-gray-400 mt-2">Interact with your unified AGI system through chat, code generation, analysis and more.</p>
    </header>
    <!-- Main layout: two columns on larger screens -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Chat and command center -->
      <section class="bg-gray-800 p-6 rounded-lg shadow-xl flex flex-col h-[32rem]">
        <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Chat & Commands</h2>
        <div id="chat-container" class="flex-1 overflow-y-auto p-4 bg-gray-900 rounded-md mb-4 space-y-4"></div>
        <div class="flex items-center space-x-2">
          <input id="command-input" type="text" autocomplete="off" placeholder="Enter command (e.g., 'generate_code a function to sort a list')" class="flex-1 p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500">
          <button id="send-btn" class="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 text-white font-semibold rounded-lg">Send</button>
        </div>
        <p class="text-xs text-gray-500 mt-2">Commands: <code>ask ...</code>, <code>generate_code ...</code>, <code>memory.store key value</code>, <code>memory.recall key</code>, <code>nlp.analysis ...</code>, etc.</p>
      </section>
      <!-- Utilities: code output, analysis, scaffolding, file upload -->
      <section class="bg-gray-800 p-6 rounded-lg shadow-xl space-y-6">
        <!-- Generated code output -->
        <div>
          <h3 class="text-xl font-semibold mb-2 border-b border-gray-700 pb-1">Generated Code</h3>
          <pre id="code-output" class="code-block h-40 overflow-y-auto"></pre>
        </div>
        <!-- NLP analysis output -->
        <div>
          <h3 class="text-xl font-semibold mb-2 border-b border-gray-700 pb-1">NLP Analysis</h3>
          <pre id="analysis-output" class="code-block h-32 overflow-y-auto"></pre>
        </div>
        <!-- Project scaffolder -->
        <div>
          <h3 class="text-xl font-semibold mb-2 border-b border-gray-700 pb-1">Project Scaffolder</h3>
          <div class="flex space-x-2 mb-2">
            <input type="text" id="project-name" class="flex-1 p-2 bg-gray-700 border border-gray-600 rounded-lg" placeholder="Project name (e.g., MyApp)" />
            <button id="scaffold-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">Create</button>
          </div>
        </div>
        <!-- File upload & analysis -->
        <div>
          <h3 class="text-xl font-semibold mb-2 border-b border-gray-700 pb-1">File Analysis</h3>
          <input type="file" id="file-upload" class="w-full mb-2" />
          <button id="analyze-file-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg">Analyze File</button>
        </div>
      </section>
    </div>
  </div>
  <script>
    // Establish connection to backend on port 5001
    const socket = io('http://localhost:5001');
    const chatContainer = document.getElementById('chat-container');
    const commandInput = document.getElementById('command-input');
    const sendBtn = document.getElementById('send-btn');
    const codeOutput = document.getElementById('code-output');
    const analysisOutput = document.getElementById('analysis-output');
    const scaffoldBtn = document.getElementById('scaffold-btn');
    const projectNameInput = document.getElementById('project-name');
    const fileUploadInput = document.getElementById('file-upload');
    const analyzeFileBtn = document.getElementById('analyze-file-btn');

    // Helper to add messages to chat
    function addMessage(sender, message) {
      const wrapper = document.createElement('div');
      wrapper.classList.add('p-3', 'rounded-lg', 'max-w-full');
      if (sender === 'user') {
        wrapper.classList.add('bg-gray-700');
        wrapper.innerHTML = `<p class="font-semibold text-cyan-400 mb-1">You</p><p>${message.replace(/\n/g, '<br>')}</p>`;
      } else {
        wrapper.classList.add('bg-gray-800');
        // Replace [CODE_BLOCK] tokens with formatted pre tags
        let formatted = message.replace(/\[CODE_BLOCK\]([\s\S]*?)\[\/CODE_BLOCK\]/g, (m, code) => {
          const escaped = code.replace(/</g, '&lt;').replace(/>/g, '&gt;');
          return `<div class="code-block">${escaped.trim()}</div>`;
        });
        wrapper.innerHTML = `<p class="font-semibold text-green-400 mb-1">AGI</p><div>${formatted}</div>`;
      }
      chatContainer.appendChild(wrapper);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function showThinking() {
      const elem = document.createElement('div');
      elem.id = 'thinking';
      elem.classList.add('p-3', 'rounded-lg', 'bg-gray-800', 'text-gray-400', 'italic');
      elem.innerText = 'Thinking...';
      chatContainer.appendChild(elem);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    function removeThinking() {
      const elem = document.getElementById('thinking');
      if (elem) elem.remove();
    }

    // Send commands on click or Enter
    sendBtn.addEventListener('click', () => {
      const cmd = commandInput.value.trim();
      if (!cmd) return;
      addMessage('user', cmd);
      socket.emit('send_command', { command: cmd });
      showThinking();
      commandInput.value = '';
    });
    commandInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
      }
    });

    // Display welcome on connect
    socket.on('connect', () => {
      addMessage('agi', 'Welcome to the Sovereign AGI Workspace. How can I assist you today?');
    });

    // Handle responses
    socket.on('agi_response', (data) => {
      removeThinking();
      const msg = data.response;
      addMessage('agi', msg);
      // Extract code if present and show in code output
      const codeMatch = msg.match(/\[CODE_BLOCK\]([\s\S]*?)\[\/CODE_BLOCK\]/);
      if (codeMatch) {
        codeOutput.textContent = codeMatch[1].trim();
      }
      // Extract NLP analysis and show separately for nlp.analysis calls
      if (msg.includes('Intent:') && msg.includes('Domain:')) {
        analysisOutput.textContent = msg;
      }
    });

    // Project scaffolding: create README, main.py and src folder in a ZIP
    scaffoldBtn.addEventListener('click', async () => {
      const name = projectNameInput.value.trim();
      if (!name) {
        alert('Please enter a project name.');
        return;
      }
      scaffoldBtn.disabled = true;
      scaffoldBtn.textContent = 'Creating...';
      try {
        const zip = new JSZip();
        zip.file('README.md', `# ${name}\n\nThis project was scaffolded by the Sovereign AGI Workspace.`);
        zip.file('main.py', `def main():\n    print('Hello from ${name}!')\n\nif __name__ == '__main__':\n    main()`);
        zip.folder('src').file('__init__.py', '');
        const content = await zip.generateAsync({ type: 'blob' });
        saveAs(content, `${name}.zip`);
        alert(`Download started: ${name}.zip`);
      } catch (err) {
        alert('Failed to create project zip.');
        console.error(err);
      } finally {
        scaffoldBtn.disabled = false;
        scaffoldBtn.textContent = 'Create';
      }
    });

    // File analysis: upload file content into memory
    analyzeFileBtn.addEventListener('click', () => {
      const file = fileUploadInput.files[0];
      if (!file) {
        alert('Please select a file first.');
        return;
      }
      const reader = new FileReader();
      reader.onload = (e) => {
        const content = e.target.result.split(',')[1];
        const command = `memory.store ${file.name} [file_content]`;
        addMessage('user', `Analyzing file: ${file.name}`);
        socket.emit('send_command', {
          command: command,
          file: { name: file.name, type: file.type, content: content }
        });
        showThinking();
      };
      reader.readAsDataURL(file);
    });
  </script>
</body>
</html>